library(tidyverse)
library(viridis)
library(scico)
library(pheatmap)
library(plotly)
library(htmlwidgets)
library(ggrastr)

# read full DEG list
full_DE <- read_tsv("./MAST_res_level2_summary.txt", col_types = "cccciicdddddllddd")
# read DEG list generated by separating male and female samples
separate_sex_DE <- read_tsv("./MAST_res_level2_separate_sex_summary.txt", col_types = "ccccccdddddllddd")

# define DE threshold
FDR_threshold <- 0.05
FC_threshold <- 1.2

selected_cell_types <- c(
  "Exc_superficial", "Exc_intermediate", "Exc_deep",
  "Inh_PVALB", "Inh_SST", "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other",
  "Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"
)

# subset significant DEGs in DE list
full_DE_sig <- full_DE %>%
  filter(
    cell_type %in% selected_cell_types,
    FDR < FDR_threshold,
    abs(model_log2FC) > log2(FC_threshold),
    conv_C == TRUE,
    conv_D == TRUE,
    model_log2FC_ci_hi * model_log2FC_ci_low > 0,
    abs(model_log2FC - avg_logFC) < 2
  )

separate_sex_DE_sig <- separate_sex_DE %>%
  filter(
    cell_type %in% selected_cell_types,
    fdr < FDR_threshold,
    abs(model_log2FC) > log2(FC_threshold),
    conv_C == TRUE,
    conv_D == TRUE,
    ci.hi * ci.lo > 0,
    abs(model_log2FC - avg_log2FC) < 2
  )

male_DE <- separate_sex_DE %>% filter(sex == "male")
female_DE <- separate_sex_DE %>% filter(sex == "female")
male_DE_sig <- separate_sex_DE_sig %>% filter(sex == "male")
female_DE_sig <- separate_sex_DE_sig %>% filter(sex == "female")

# n_all_genes <- 33538
n_all_genes <- c(pull(full_DE, gene), pull(separate_sex_DE, gene)) %>%
  unique() %>%
  length()
n_all_genes

# define a function to retrieve selected tibble
get_DE_list <- function(set) {
  if (set == "full") {
    return(full_DE_sig)
  } else if (set == "male") {
    return(male_DE_sig)
  } else if (set == "female") {
    return(female_DE_sig)
  } else {
    stop("Invalid input. Please use 'full', 'male', or 'female'.")
  }
}

# get Jaccard index for selected pair-wise comparisons
get_jaccard <- function(
    set_1,
    set_2,
    selected_cell_type_set_1,
    selected_cell_type_set_2,
    selected_cond_1,
    selected_cond_2,
    selected_region) {
  df_set_1 <- get_DE_list(set_1)
  df_set_2 <- get_DE_list(set_2)

  df_set_1_sub <- df_set_1 %>%
    filter(
      cell_type == selected_cell_type_set_1,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    pull(gene)

  df_set_2_sub <- df_set_2 %>%
    filter(
      cell_type == selected_cell_type_set_2,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    pull(gene)

  tibble(
    set_1 = set_1,
    set_2 = set_2,
    cell_type_set_1 = selected_cell_type_set_1,
    cell_type_set_2 = selected_cell_type_set_2,
    cond_1 = selected_cond_1,
    cond_2 = selected_cond_2,
    region = selected_region,
    n_DE_set_1 = length(df_set_1_sub),
    n_DE_set_2 = length(df_set_2_sub),
    n_intersection = length(intersect(df_set_1_sub, df_set_2_sub)),
    n_union = length(union(df_set_1_sub, df_set_2_sub)),
    jaccard_index = n_intersection / n_union,
    p_hyper = sum(dhyper(n_intersection:n_DE_set_2, n_DE_set_1, n_all_genes - n_DE_set_1, n_DE_set_2)),
  )
}

# get_jaccard("full", "male", "Astro", "Astro", "ALS", "Control", "MCX")

params <- expand_grid(
  set_1 = c("full", "male", "female"),
  set_2 = c("full", "male", "female"),
  selected_cell_type_set_1 = selected_cell_types,
  selected_cell_type_set_2 = selected_cell_types,
  selected_cond_1 = c("ALS", "FTD"),
  selected_cond_2 = "Control",
  selected_region = c("MCX", "mFCX")
)

res <- pmap_df(params, get_jaccard)
write_tsv(res, "DE_genes_overlaps_jaccard_full_dataset_vs_separated_sex.txt")
# res <- read_tsv("DE_genes_overlaps_jaccard_full_dataset_vs_separated_sex.txt")


# plot heatmap of Jaccard index
res_sig <- res %>%
  # filter(p_hyper < 0.05) %>%
  filter(
    cond_1 == "ALS",
    region == "MCX"
    # region == "mFCX"
  ) %>%
  mutate(
    cell_type_set_1 = factor(
      cell_type_set_1,
      levels = c(
        "Astro", "Micro", "Oligo", "OPC", "Endo", "VLMC",
        "Exc_superficial", "Exc_intermediate", "Exc_deep",
        "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other", "Inh_PVALB", "Inh_SST"
      )
    ),
    cell_type_set_2 = factor(
      cell_type_set_2,
      levels = c(
        "Astro", "Micro", "Oligo", "OPC", "Endo", "VLMC",
        "Exc_superficial", "Exc_intermediate", "Exc_deep",
        "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other", "Inh_PVALB", "Inh_SST"
      )
    )
  ) %>%
  arrange(cell_type_set_1, cell_type_set_2) %>%
  mutate(
    group_1 = paste0(set_1, "_", cell_type_set_1),
    group_2 = paste0(set_2, "_", cell_type_set_2)
  )

res_mat <- res_sig %>%
  select(group_1, group_2, jaccard_index) %>%
  pivot_wider(names_from = "group_2", values_from = "jaccard_index", values_fill = NA_real_) %>%
  as.data.frame() %>%
  column_to_rownames("group_1")

row_annotations <- res_sig %>%
  distinct(group_1, cell_type_set_1) %>%
  as.data.frame() %>%
  column_to_rownames("group_1")
column_annotations <- res_sig %>%
  distinct(group_2, cell_type_set_2) %>%
  as.data.frame() %>%
  column_to_rownames("group_2")

annotations_colors <- list(
  cell_type_set_1 = c(
    "Astro" = "#ef6075",
    "Micro" = "#ec5b42",
    "Oligo" = "#89520d",
    "OPC" = "#b98735",
    "Endo" = "#ad312c",
    "VLMC" = "#7c5816",
    "Exc_superficial" = "#54c879",
    "Exc_intermediate" = "#bfe676",
    "Exc_deep" = "#c9a836",
    "Inh_VIP" = "#cb0077",
    "Inh_LAMP5" = "#016cf2",
    "Inh_ADARB2_Other" = "#02a7b8",
    "Inh_PVALB" = "#8e90d8",
    "Inh_SST" = "#721297"
  ),
  cell_type_set_2 = c(
    "Astro" = "#ef6075",
    "Micro" = "#ec5b42",
    "Oligo" = "#89520d",
    "OPC" = "#b98735",
    "Endo" = "#ad312c",
    "VLMC" = "#7c5816",
    "Exc_superficial" = "#54c879",
    "Exc_intermediate" = "#bfe676",
    "Exc_deep" = "#c9a836",
    "Inh_VIP" = "#cb0077",
    "Inh_LAMP5" = "#016cf2",
    "Inh_ADARB2_Other" = "#02a7b8",
    "Inh_PVALB" = "#8e90d8",
    "Inh_SST" = "#721297"
  )
)

pheatmap(res_mat,
  cluster_cols = FALSE,
  cluster_rows = FALSE,
  border_color = NA,
  cellwidth = 5.5,
  cellheight = 5.5,
  fontsize = 5.5,
  annotation_col = column_annotations,
  annotation_row = row_annotations,
  annotation_colors = annotations_colors,
  filename = "DE_overlaps_jaccard_index_ALS_vs_Control_MCX_full_dataset_vs_separated_sex.pdf",
  # filename = "DE_overlaps_jaccard_index_ALS_vs_Control_mFCX_full_dataset_vs_separated_sex.pdf",
  width = 6, height = 6
)

res_sig_FTD <- res %>%
  # filter(p_hyper < 0.05) %>%
  filter(
    cond_1 == "FTD",
    # region == "MCX"
    region == "mFCX"
  ) %>%
  filter(
    !grepl("Exc_|Inh_", cell_type_set_1),
    !grepl("Exc_|Inh_", cell_type_set_2)
  ) %>%
  mutate(
    cell_type_set_1 = factor(
      cell_type_set_1,
      levels = c(
        "Astro", "Micro", "Oligo", "OPC", "Endo", "VLMC"
      )
    ),
    cell_type_set_2 = factor(
      cell_type_set_2,
      levels = c(
        "Astro", "Micro", "Oligo", "OPC", "Endo", "VLMC"
      )
    )
  ) %>%
  arrange(cell_type_set_1, cell_type_set_2) %>%
  mutate(
    group_1 = paste0(set_1, "_", cell_type_set_1),
    group_2 = paste0(set_2, "_", cell_type_set_2)
  )

res_mat_FTD <- res_sig_FTD %>%
  select(group_1, group_2, jaccard_index) %>%
  pivot_wider(names_from = "group_2", values_from = "jaccard_index", values_fill = NA_real_) %>%
  as.data.frame() %>%
  column_to_rownames("group_1")

row_annotations_FTD <- res_sig_FTD %>%
  distinct(group_1, cell_type_set_1) %>%
  as.data.frame() %>%
  column_to_rownames("group_1")
column_annotations_FTD <- res_sig_FTD %>%
  distinct(group_2, cell_type_set_2) %>%
  as.data.frame() %>%
  column_to_rownames("group_2")

pheatmap(res_mat_FTD,
  cluster_cols = FALSE,
  cluster_rows = FALSE,
  border_color = NA,
  cellwidth = 5.5,
  cellheight = 5.5,
  fontsize = 5.5,
  annotation_col = column_annotations_FTD,
  annotation_row = row_annotations_FTD,
  annotation_colors = annotations_colors,
  # filename = "DE_overlaps_jaccard_index_FTD_vs_Control_MCX_full_dataset_vs_separated_sex.pdf",
  filename = "DE_overlaps_jaccard_index_FTD_vs_Control_mFCX_full_dataset_vs_separated_sex.pdf",
  width = 6, height = 6
)

# plot only male vs. female DEGs overlaps jackard index
male_vs_female_jaccard <- res %>%
  filter(
    set_1 != "full",
    set_2 != "full",
    set_1 != set_2,
    set_1 == "male",
    cell_type_set_1 == cell_type_set_2
  ) %>%
  mutate(
    cell_type_set_1 = factor(
      cell_type_set_1,
      levels = rev(c(
        "Exc_superficial", "Exc_intermediate", "Exc_deep",
        "Inh_PVALB", "Inh_SST", "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other",
        "Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"
      ))
    ),
    region = factor(region, levels = c("mFCX", "MCX"))
  )

region_labels <- c("MCX" = "Motor", "mFCX" = "Frontal")
region_color <- c("MCX" = "#432266", "mFCX" = "#FAA51B")
relabel_region <- function(x) {
  region_labels[x]
}

p <- male_vs_female_jaccard %>%
  filter(cond_1 == "ALS") %>%
  ggplot(aes(cell_type_set_1, jaccard_index))

p +
  geom_bar(
    aes(fill = region),
    stat = "identity",
    position = position_dodge(0.8),
    width = 0.8
  ) +
  scale_fill_manual(
    values = region_color,
    name = "Brain region",
    breaks = c("MCX", "mFCX"),
    labels = relabel_region
  ) +
  coord_flip() +
  ylab(
    str_glue(
      "Jaccard index of overlapping significant DEGs\n",
      "(FDR < {FDR_threshold}, FC > {FC_threshold})\n",
      "using male only or female only samples"
    )
  ) +
  xlab("Major cell types") +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave(
  str_glue("MAST_ALS_vs_Control_separated_sex_num_sig_DE_fdr{FDR_threshold}_FC{FC_threshold}_level_2_ordered_male_vs_female_overlapDEGs_jaccard_index.pdf"),
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()


p <- male_vs_female_jaccard %>%
  filter(cond_1 == "FTD") %>%
  filter(!grepl("Exc_|Inh_", cell_type_set_1)) %>%
  ggplot(aes(cell_type_set_1, jaccard_index))

p +
  geom_bar(
    aes(fill = region),
    stat = "identity",
    position = position_dodge(0.8),
    width = 0.8
  ) +
  scale_fill_manual(
    values = region_color,
    name = "Brain region",
    breaks = c("MCX", "mFCX"),
    labels = relabel_region
  ) +
  coord_flip() +
  ylab(
    str_glue(
      "Jaccard index of overlapping significant DEGs\n",
      "(FDR < {FDR_threshold}, FC > {FC_threshold})\n",
      "using male only or female only samples"
    )
  ) +
  xlab("Major cell types") +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave(
  str_glue("MAST_FTD_vs_Control_separated_sex_num_sig_DE_fdr{FDR_threshold}_FC{FC_threshold}_level_2_ordered_male_vs_female_overlapDEGs_jaccard_index.pdf"),
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()



# plot number of significant DEGs by sex
num_DEG <- separate_sex_DE_sig %>%
  count(cond_1, cond_2, cell_type, region, sex) %>%
  complete(
    fill = list(n = 0),
    cond_1 = unique(cond_1),
    cond_2 = unique(cond_2),
    cell_type = unique(cell_type),
    region = unique(region),
    sex = unique(sex)
  ) %>%
  mutate(
    cell_type = factor(
      cell_type,
      levels = rev(c(
        "Exc_superficial", "Exc_intermediate", "Exc_deep",
        "Inh_PVALB", "Inh_SST", "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other",
        "Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"
      ))
    ),
    sex = factor(sex, levels = c("female", "male"))
  )

sex_color <- c("male" = "#3D304C", "female" = "#FC9E89")

p <- num_DEG %>%
  filter(cond_1 == "ALS", cond_2 == "Control") %>%
  ggplot(aes(cell_type, n))
p +
  geom_bar(
    aes(fill = sex),
    stat = "identity",
    position = position_dodge(0.8),
    width = 0.8
  ) +
  facet_wrap(~region, ncol = 2) +
  scale_fill_manual(values = sex_color, name = "Sex", breaks = c("male", "female")) +
  coord_flip() +
  ylab(str_glue("# significant DE genes (FDR < {FDR_threshold}, FC > {FC_threshold})")) +
  xlab("Major cell types") +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave(
  str_glue("MAST_ALS_vs_Control_separated_sex_num_sig_DE_fdr{FDR_threshold}_FC{FC_threshold}_level_2_ordered.pdf"),
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()

p <- num_DEG %>%
  filter(cond_1 == "FTD", cond_2 == "Control") %>%
  filter(!grepl("Exc_|Inh_", cell_type)) %>%
  ggplot(aes(cell_type, n))
p +
  geom_bar(
    aes(fill = sex),
    stat = "identity",
    position = position_dodge(0.8),
    width = 0.8
  ) +
  facet_wrap(~region, ncol = 2) +
  scale_fill_manual(values = sex_color, name = "Sex", breaks = c("male", "female")) +
  coord_flip() +
  ylab(str_glue("# significant DE genes (FDR < {FDR_threshold}, FC > {FC_threshold})")) +
  xlab("Major cell types") +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    strip.background = element_blank(),
    panel.grid.minor = element_blank()
  )

ggsave(
  str_glue("MAST_FTD_vs_Control_separated_sex_num_sig_DE_fdr{FDR_threshold}_FC{FC_threshold}_level_2_ordered.pdf"),
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()

# get Pearson/Spearman correlation of log2FC between for DEGs from full dataset and subset of separated sex
get_complete_DE_list <- function(set) {
  if (set == "full") {
    return(full_DE)
  } else if (set == "male") {
    return(male_DE)
  } else if (set == "female") {
    return(female_DE)
  } else {
    stop("Invalid input. Please use 'full', 'male', or 'female'.")
  }
}

set_colors <- c(
  "both" = "#D9252A",
  "full" = "#286A8F",
  "male" = "#3D304C",
  "female" = "#FC9E89"
)

plot_FC_cor <- function(
    set_1,
    set_2,
    selected_cell_type,
    selected_cond_1,
    selected_cond_2,
    selected_region) {
  message(str_glue(
    "Processing {set_1} vs. {set_2}",
    "{selected_cell_type} in {selected_region} ",
    "with FC > {FC_threshold} and FDR < {FDR_threshold},",
    "{selected_cond_1} vs. {selected_cond_2}"
  ))

  set_1_FC <- get_complete_DE_list(set_1) %>%
    filter(
      cell_type == selected_cell_type,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    select(gene, model_log2FC) %>%
    rename(set_1_log2FC = model_log2FC)

  set_2_FC <- get_complete_DE_list(set_2) %>%
    filter(
      cell_type == selected_cell_type,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    select(gene, model_log2FC) %>%
    rename(set_2_log2FC = model_log2FC)

  set_1_DE_genes <- get_DE_list(set_1) %>%
    filter(
      cell_type == selected_cell_type,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    pull(gene)

  set_2_DE_genes <- get_DE_list(set_2) %>%
    filter(
      cell_type == selected_cell_type,
      cond_1 == selected_cond_1,
      cond_2 == selected_cond_2,
      region == selected_region
    ) %>%
    pull(gene)

  if (length(set_1_DE_genes) == 0) {
    message(str_glue("No significant DE genes in {set_1} {selected_region} {selected_cell_type}!"))
  } else if (length(set_2_DE_genes) == 0) {
    message(str_glue("No significant DE genes in {set_2} {selected_region} {selected_cell_type}!"))
  } else {
    union_gene_list <- union(set_1_DE_genes, set_2_DE_genes)

    res <- set_1_FC %>%
      full_join(set_2_FC, by = c("gene" = "gene")) %>%
      filter(gene %in% union_gene_list) %>%
      mutate(
        set_1 = set_1,
        set_2 = set_2,
        cell_type = selected_cell_type,
        cond_1 = selected_cond_1,
        cond_2 = selected_cond_2,
        region = selected_region,
        DE_in_set = case_when(
          (gene %in% set_1_DE_genes) & (gene %in% set_2_DE_genes) ~ "both",
          (gene %in% set_1_DE_genes) & !(gene %in% set_2_DE_genes) ~ set_1,
          !(gene %in% set_1_DE_genes) & (gene %in% set_2_DE_genes) ~ set_2,
          TRUE ~ "neither"
        )
      )

    write_tsv(
      res,
      str_glue(
        "./plot_vs_separate_sex/",
        "{selected_cond_1}_vs_{selected_cond_2}_{selected_cell_type}_",
        "{set_1}_vs_{set_2}_in_{selected_region}_",
        "FC_{FC_threshold}_FDR_{FDR_threshold}_merged_table.tsv"
      )
    )

    cor_spearman <- cor.test(res$set_1_log2FC, res$set_2_log2FC, method = "spearman")
    cor_pearson <- cor.test(res$set_1_log2FC, res$set_2_log2FC, method = "pearson")
    num_overlap_DE_genes <- intersect(set_1_DE_genes, set_2_DE_genes) %>% length()
    num_union_DE_genes <- length(union_gene_list)

    rho <- round(cor_spearman$estimate, 3)
    p_value_spearman <- signif(cor_spearman$p.value, 3)
    pearson_r <- round(cor_pearson$estimate, 3)
    p_value_pearson <- signif(cor_pearson$p.value, 3)

    out_stat_df <- tibble(
      set_1 = set_1,
      set_2 = set_2,
      cond_1 = selected_cond_1,
      cond_2 = selected_cond_2,
      cell_type = selected_cell_type,
      region = selected_region,
      FC_threshold = FC_threshold,
      FDR_threshold = FDR_threshold,
      num_overlap_DE_genes = num_overlap_DE_genes,
      num_union_DE_genes = num_union_DE_genes,
      spearman_rho = cor_spearman$estimate,
      spearman_p_value = cor_spearman$p.value,
      pearson_r = cor_pearson$estimate,
      pearson_p_value = cor_pearson$p.value
    )
    write_tsv(
      out_stat_df,
      str_glue(
        "./plot_vs_separate_sex/",
        "{selected_cond_1}_vs_{selected_cond_2}_{selected_cell_type}_",
        "{set_1}_vs_{set_2}_in_{selected_region}_",
        "FC_{FC_threshold}_FDR_{FDR_threshold}_stat.tsv"
      )
    )

    set.seed(666)
    p <- res %>%
      sample_n(nrow(res), replace = FALSE) %>%
      ggplot(aes(set_1_log2FC, set_2_log2FC))
    p1 <- p +
      geom_hline(yintercept = 0, color = "darkgrey", linetype = 2) +
      geom_vline(xintercept = 0, color = "darkgrey", linetype = 2) +
      geom_point_rast(aes(color = DE_in_set), scale = 0.5) +
      scale_color_manual(values = set_colors) +
      xlab(str_glue("Gene expresssion log2FC\n({selected_cond_1} vs. {selected_cond_2})\nin set {set_1}")) +
      ylab(str_glue("Gene expresssion log2FC\n({selected_cond_1} vs. {selected_cond_2})\nin set {set_2}")) +
      ggtitle(
        str_glue(
          "{selected_cell_type} in {selected_region}\n",
          "FC > {FC_threshold}, FDR < {FDR_threshold}\n",
          "n = {num_union_DE_genes}, rho = {rho}, p = {p_value_spearman},",
          "r = {pearson_r}, p = {p_value_pearson}"
        )
      ) +
      theme_bw(base_size = 8, base_family = "Helvetica") +
      theme(
        panel.grid.minor = element_blank(),
        legend.key.size = unit(0.5, "lines")
      )
    ggsave(
      str_glue(
        "./plot_vs_separate_sex/",
        "{selected_cond_1}_vs_{selected_cond_2}_{selected_cell_type}_",
        "{set_1}_vs_{set_2}_in_{selected_region}_",
        "FC_{FC_threshold}_FDR_{FDR_threshold}.pdf"
      ),
      plot = p1, device = cairo_pdf(),
      width = 4, height = 3, useDingbats = FALSE
    )
    dev.off()

    p2 <- p +
      geom_hline(yintercept = 0, color = "darkgrey", linetype = 2) +
      geom_vline(xintercept = 0, color = "darkgrey", linetype = 2) +
      geom_point(size = 0.2, aes(label = gene, color = DE_in_set)) +
      scale_color_manual(values = set_colors) +
      xlab(str_glue("Gene expresssion log2FC\n({selected_cond_1} vs. {selected_cond_2})\nin set {set_1}")) +
      ylab(str_glue("Gene expresssion log2FC\n({selected_cond_1} vs. {selected_cond_2})\nin set {set_2}")) +
      ggtitle(
        str_glue(
          "{selected_cell_type} in {selected_region}\n",
          "FC > {FC_threshold}, FDR < {FDR_threshold}\n",
          "n = {num_union_DE_genes}, rho = {rho}, p = {p_value_spearman},",
          "r = {pearson_r}, p = {p_value_pearson}"
        )
      ) +
      theme_bw(base_size = 8, base_family = "Helvetica") +
      theme(panel.grid.minor = element_blank())
    p2 <- ggplotly(p2)
    saveWidget(
      p2,
      str_glue(
        "./plot_vs_separate_sex/",
        "{selected_cond_1}_vs_{selected_cond_2}_{selected_cell_type}_",
        "{set_1}_vs_{set_2}_in_{selected_region}_",
        "FC_{FC_threshold}_FDR_{FDR_threshold}.html"
      ),
      selfcontained = TRUE
    )
  }
}

# plot_FC_cor("full", "male", "Astro", "ALS", "Control", "MCX")
# plot_FC_cor("male", "female", "Astro", "ALS", "Control", "MCX")
# plot_FC_cor("full", "male", "Inh_VIP", "FTD", "Control", "MCX")

params <- expand_grid(
  set_1 = c("full", "male"),
  set_2 = c("male", "female"),
  selected_cell_type = c(
    "Exc_superficial", "Exc_intermediate", "Exc_deep",
    "Inh_PVALB", "Inh_SST", "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other",
    "Astro", "Endo", "Micro", "Oligo", "OPC"
  ),
  selected_cond_1 = c("ALS"),
  selected_cond_2 = "Control",
  selected_region = c("MCX", "mFCX")
) %>%
  filter(set_1 != set_2)

pwalk(params, plot_FC_cor)

params <- expand_grid(
  set_1 = c("full", "male"),
  set_2 = c("male", "female"),
  selected_cell_type = c(
    "VLMC"
  ),
  selected_cond_1 = c("ALS"),
  selected_cond_2 = "Control",
  selected_region = c("MCX", "mFCX")
) %>%
  filter(set_1 != set_2)

pwalk(params[2:6, ], plot_FC_cor)

params <- expand_grid(
  set_1 = c("full", "male"),
  set_2 = c("male", "female"),
  selected_cell_type = c("Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"),
  selected_cond_1 = c("FTD"),
  selected_cond_2 = "Control",
  selected_region = c("MCX", "mFCX")
) %>%
  filter(set_1 != set_2)

pwalk(params, plot_FC_cor)


# read summarized FC correlation results
cor_summary <- read_tsv("./full_vs_separate_sex_DEGs_FC_correlations_summary.tsv")

group_colors <- c(
  "full vs. male" = "#3D304C",
  "full vs. female" = "#FC9E89",
  "male vs. female" = "#19A7CE"
)

p <- cor_summary %>%
  filter(cond_1 == "ALS") %>%
  mutate(group = paste0(set_1, " vs. ", set_2)) %>%
  mutate(
    cell_type = factor(cell_type,
      levels = rev(c(
        "Exc_superficial", "Exc_intermediate", "Exc_deep",
        "Inh_PVALB", "Inh_SST", "Inh_VIP", "Inh_LAMP5", "Inh_ADARB2_Other",
        "Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"
      )
    ))
  ) %>%
  ggplot(aes(cell_type, spearman_rho))

p +
  geom_hline(yintercept = 0, color = "darkgrey", linetype = 2) +
  geom_point(aes(color = group)) +
  facet_wrap(~region, ncol = 2) +
  scale_color_manual(values = group_colors, name = "DEG comparison") +
  ylab("Spearman correlation of log2FC of DEGs (ALS vs. Control)") +
  xlab("Major cell types") +
  coord_flip() +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    legend.key.size = unit(0.5, "lines")
  )

ggsave(
  "./plot_vs_separate_sex/full_vs_separate_sex_DEG_FC_correlation_ALS_vs_Control.pdf",
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()

p <- cor_summary %>%
  filter(cond_1 == "FTD") %>%
  filter(!grepl("Exc_|Inh_", cell_type)) %>%
  mutate(group = paste0(set_1, " vs. ", set_2)) %>%
  mutate(
    cell_type = factor(cell_type,
      levels = rev(c(
        "Astro", "Endo", "Micro", "Oligo", "OPC", "VLMC"
      )
    ))
  ) %>%
  ggplot(aes(cell_type, spearman_rho))

p +
  geom_hline(yintercept = 0, color = "darkgrey", linetype = 2) +
  geom_point(aes(color = group)) +
  facet_wrap(~region, ncol = 2) +
  scale_color_manual(values = group_colors, name = "DEG comparison") +
  ylab("Spearman correlation of log2FC of DEGs (FTD vs. Control)") +
  xlab("Major cell types") +
  coord_flip() +
  theme_bw(base_size = 8, base_family = "Helvetica") +
  theme(
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    legend.key.size = unit(0.5, "lines")
  )

ggsave(
  "./plot_vs_separate_sex/full_vs_separate_sex_DEG_FC_correlation_FTD_vs_Control.pdf",
  device = cairo_pdf(),
  width = 4,
  height = 2,
  useDingbats = FALSE
)
dev.off()
